name: Test Cron Timing

on:
  schedule:
    # 12月19日 日本時間 10:52 (UTC 01:52) に実行
    - cron: "52 1 19 12 *"
    # 12月19日 日本時間 11:08 (UTC 02:08) に再実行
    - cron: "8 2 19 12 *"
  workflow_dispatch:
      inputs:
        action:
          description: "実行するアクション"
          required: true
          type: choice
          options:
            - set_discount
            - end_discount
jobs:
  discount:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create Google credentials file
        env:
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        run: |
          echo "$GOOGLE_CREDENTIALS_JSON" > /tmp/google-credentials.json
          chmod 600 /tmp/google-credentials.json

      - name: Create .env file
        env:
          BLOSSOMHCOMPANY_ACCESS_TOKEN: ${{ secrets.BLOSSOMHCOMPANY_ACCESS_TOKEN }}
          BLOSSOMHCOMPANY_GSPREAD_ID: ${{ secrets.BLOSSOMHCOMPANY_GSPREAD_ID }}
        run: |
          cat > .env << EOF
          blossomhcompany-ACCESS_TOKEN=$BLOSSOMHCOMPANY_ACCESS_TOKEN
          GOOGLE_CREDENTIAL_PATH=/tmp/google-credentials.json
          blossomhcompany-GSPREAD_ID=$BLOSSOMHCOMPANY_GSPREAD_ID
          EOF

      - name: Determine script to run
        id: script
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.action }}" = "set_discount" ]; then
              echo "script=set_discount.py" >> $GITHUB_OUTPUT
            else
              echo "script=end_discount.py" >> $GITHUB_OUTPUT
            fi
          else
            # スケジュール実行の場合、deterimned by cron time
            if [ "${{github.event.schedule}}" = "52 1 19 12 *" ]; then
              echo "script=set_discount.py" >> $GITHUB_OUTPUT
            else
              echo "script=end_discount.py" >> $GITHUB_OUTPUT
            fi
          fi

      - name: just echo the script name
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          echo "${{ steps.script.outputs.script }}"

      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/google-credentials.json
